<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”¨</text></svg>">
    <title>ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1>LinkReplacer</h1>
    ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆå·¦ï¼‰å†…ã®ãƒªãƒ³ã‚¯ã‚’ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆï¼ˆå³ï¼‰ã«ç½®ãæ›ãˆã¾ã™ã€‚èµ¤ã„ç•ªå·ã§ç…§åˆã—ãªãŒã‚‰é©åˆ‡ãªä½ç½®ã«ãƒªãƒ³ã‚¯ãŒç½®ãæ›ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã€ˆãƒªãƒ³ã‚¯ã‚’ç½®ãæ›ãˆã€‰ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<br />
    <!-- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã‚’æ¨ªã«ä¸¦ã¹ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="drop-areas-container">
        <div id="drop-area-html" class="drop-area" tabindex="0">
            ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</br>ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.htmlã‹.txtï¼‰ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€‚<br />ãƒšãƒ¼ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã‹ã‚¿ãƒ–ã‚­ãƒ¼ã§é¸æŠã—ã¦ã‹ã‚‰</div>
        <div id="drop-area-text" class="drop-area" tabindex="0">
            ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆ</br>ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.txtã‹.xlsxï¼‰ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã€‚<br />ãƒšãƒ¼ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã‹ã‚¿ãƒ–ã‚­ãƒ¼ã§é¸æŠã—ã¦ã‹ã‚‰</div>
    </div>

    <!-- å†…å®¹ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="file-content-container">
        <!-- å·¦å´ -->
        <div>
            <div id="result-container-html" class="result-container"></div>
            <div class="view-controls">
                <button id="viewToggle" class="toggle-button">HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º</button>
            </div>
            <div id="file-content-html" style="display: none;"></div>
            <div id="html-preview" style="display: none;"></div>
        </div>
        <!-- å³å´ -->
        <div>
            <div id="result-container-text" class="result-container"></div>
            <div id="file-content-text" style="display: none;">
                <!--ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«-->
            </div>
        </div>
    </div>

    <!-- æ¯”è¼ƒã¨ç½®æ›ã®ãƒœã‚¿ãƒ³ -->
    <div class="action-controls">
        <button id="compareButton" class="action-button">ãƒªãƒ³ã‚¯ã‚’ç½®ãæ›ãˆ</button>
    </div>

    <!-- æ¯”è¼ƒçµæœã¨ç½®ãæ›ãˆçµæœã‚’è¡¨ç¤ºã™ã‚‹ -->
    <div class="compare-container">
        <div class="copy-button-container">
            <button id="copyButton" class="copy-button">ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div id="compare-result" class="result-container"></div>
    </div>

    <!-- xlsxãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let originalContent = '';

        // UIãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        const uiHandler = {
            displayResult(message, success, targetArea) {
                const resultContainer = document.getElementById(`result-container-${targetArea}`);
                if (!resultContainer) {
                    console.error("Result container not found for targetArea:", targetArea);
                    return;
                }
                resultContainer.style.display = "block";
                const resultMessage = document.createElement("div");
                resultMessage.classList.add("result-message", success ? "success" : "error");
                resultMessage.textContent = message;
                resultContainer.innerHTML = "";
                resultContainer.appendChild(resultMessage);
            }
        };

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        const fileHandler = {
            processHTML(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalContent = e.target.result;
                    const fileContentHtmlDiv = document.getElementById("file-content-html");
                    const htmlPreviewDiv = document.getElementById("html-preview");

                    fileContentHtmlDiv.textContent = originalContent;
                    htmlPreviewDiv.innerHTML = originalContent;

                    const linkCount = linkHandler.countLinksInHtml(originalContent);
                    uiHandler.displayResult(`HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒªãƒ³ã‚¯æ•°: ${linkCount}`, true, "html");
                };
                reader.readAsText(file);
            },

            processText(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileContent = e.target.result;
                    const fileContentTextDiv = document.getElementById("file-content-text");

                    if (fileContentTextDiv) {
                        const lines = fileContent.split('\n');
                        let urlIndex = 1;
                        const numberedContent = lines.map(line => {
                            if (line.trim() !== "" && /\.[a-zA-Z0-9]+/.test(line)) {
                                return `<div class="url-line"><span class="link-number">${urlIndex++}</span>${line}</div>`;
                            }
                            return line;
                        }).join('\n');

                        fileContentTextDiv.innerHTML = numberedContent;
                        fileContentTextDiv.style.display = "block";

                        const linkCount = linkHandler.countLinksInText(fileContent);
                        uiHandler.displayResult(`ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒªãƒ³ã‚¯æ•°: ${linkCount}`, true, "text");
                    }
                };
                reader.readAsText(file);
            },

            processFile(file, targetArea) {
                const reader = new FileReader();

                if (targetArea === "html" && (file.type === "text/plain" || file.type === "text/html")) {
                    reader.onload = (e) => {
                        let fileContent = e.target.result;
                        originalContent = fileContent;
                        const linkCount = linkHandler.countLinksInHtml(fileContent);

                        let escapedContent = fileContent.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        let linkIndex = 1;
                        escapedContent = escapedContent.replace(/&lt;a href="([^"]+)"/g, function (match, p1) {
                            const numberBadge = `<span class="link-number">${linkIndex++}</span>`;
                            const redUrl = `${numberBadge}<span class="red-link">${p1}</span>`;
                            return `&lt;a href="${redUrl}"`;
                        });

                        const fileContentHtmlDiv = document.getElementById("file-content-html");
                        const htmlPreviewDiv = document.getElementById("html-preview");

                        fileContentHtmlDiv.innerHTML = escapedContent;

                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = fileContent;
                        const links = tempDiv.getElementsByTagName('a');
                        Array.from(links).forEach((link, index) => {
                            link.setAttribute('data-link-index', index + 1);
                        });
                        htmlPreviewDiv.innerHTML = tempDiv.innerHTML;

                        uiHandler.displayResult(`HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒªãƒ³ã‚¯æ•°: ${linkCount}`, true, "html");
                        fileContentHtmlDiv.style.display = "block";

                        this.setupViewToggle();
                    };
                    reader.readAsText(file);
                } else if (targetArea === "text" && file.type === "text/plain") {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const fileContent = e.target.result;
                        const fileContentTextDiv = document.getElementById("file-content-text");

                        if (fileContentTextDiv) {
                            const lines = fileContent.split('\n');
                            let urlIndex = 1;
                            const numberedContent = lines.map(line => {
                                if (line.trim() !== "" && /\.[a-zA-Z0-9]+/.test(line)) {
                                    return `<div class="url-line"><span class="link-number">${urlIndex++}</span>${line}</div>`;
                                }
                                return line;
                            }).join('\n');

                            fileContentTextDiv.innerHTML = numberedContent;
                            fileContentTextDiv.style.display = "block";

                            const linkCount = linkHandler.countLinksInText(fileContent);
                            uiHandler.displayResult(`ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒªãƒ³ã‚¯æ•°: ${linkCount}`, true, "text");
                        }
                    };
                    reader.readAsText(file);
                } else if (targetArea === "text" &&
                    (file.type === "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" ||
                        file.name.endsWith(".xlsx"))) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                        const fileContentTextDiv = document.getElementById("file-content-text");
                        const isOneDimensional = jsonData.every(row => row.length === 1);

                        if (isOneDimensional) {
                            const urlList = jsonData.map(row => row[0]);
                            this.processText(new Blob([urlList.join('\n')], { type: 'text/plain' }));
                        } else {
                            uiHandler.displayResult("Excelãƒ•ã‚¡ã‚¤ãƒ«ã¯1åˆ—ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™", false, "text");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    const message = targetArea === "html" ? "ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚" : "ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚";
                    const targetDiv = targetArea === "html" ? document.getElementById("file-content-html") : document.getElementById("file-content-text");
                    targetDiv.textContent = message;
                }
            },

            setupViewToggle() {
                const toggleButton = document.getElementById('viewToggle');
                const sourceView = document.getElementById('file-content-html');
                const previewView = document.getElementById('html-preview');

                toggleButton.addEventListener('click', function () {
                    const isShowingPreview = sourceView.style.display === 'none';

                    if (isShowingPreview) {
                        sourceView.style.display = 'block';
                        previewView.style.display = 'none';
                        toggleButton.textContent = 'HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º';
                        toggleButton.classList.remove('active');
                    } else {
                        sourceView.style.display = 'none';
                        previewView.style.display = 'block';
                        toggleButton.textContent = 'ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è¡¨ç¤º';
                        toggleButton.classList.add('active');
                    }
                });
            }
        };

        // ãƒªãƒ³ã‚¯å‡¦ç†ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        const linkHandler = {
            countLinksInHtml(htmlContent) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, "text/html");
                const links = doc.querySelectorAll("a");
                return links.length;
            },

            countLinksInText(textContent) {
                const lines = textContent.split('\n');
                const filteredLines = lines.filter(line => {
                    const extensionPattern = /\.[a-zA-Z0-9]+/g;
                    return line.trim() !== "" && extensionPattern.test(line);
                });
                return filteredLines.length;
            },

            replaceLinks() {
                const htmlContent = originalContent;
                const fileContentTextDiv = document.getElementById("file-content-text");
                const compareResult = document.getElementById("compare-result");
                const compareContainer = document.querySelector(".compare-container");

                if (!htmlContent || !fileContentTextDiv.textContent) {
                    alert("HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨URLãƒªã‚¹ãƒˆã®ä¸¡æ–¹ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                const urlList = fileContentTextDiv.innerHTML
                    .split('\n')
                    .filter(line => line.trim() !== "" && /\.[a-zA-Z0-9]+/.test(line))
                    .map(line => {
                        const div = document.createElement('div');
                        div.innerHTML = line;
                        const spans = div.getElementsByTagName('span');
                        while (spans.length > 0) {
                            spans[0].remove();
                        }
                        return div.textContent.trim();
                    });

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, "text/html");
                const links = doc.getElementsByTagName('a');

                const replacedUrls = new Set();
                Array.from(links).forEach((link, index) => {
                    if (urlList[index]) {
                        replacedUrls.add(urlList[index]);
                        link.href = urlList[index];
                    }
                });

                let resultHtml = doc.body.innerHTML;
                resultHtml = resultHtml.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                resultHtml = resultHtml.replace(/href="([^"]+)"/g, (match, url) => {
                    const colorClass = replacedUrls.has(url) ? 'blue-link' : 'red-link';
                    return `href="<span class="${colorClass}">${url}</span>"`;
                });

                compareResult.innerHTML = `
            <h3>ç½®æ›çµæœï¼ˆ${links.length}å€‹ä¸­${urlList.length}å€‹ã®ãƒªãƒ³ã‚¯ã‚’ç½®æ›ï¼‰</h3>
            <div class="result-code">${resultHtml}</div>
        `;
                compareContainer.style.display = "block";

                const copyButton = document.getElementById('copyButton');
                copyButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(doc.body.innerHTML).then(() => {
                        copyButton.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                        copyButton.classList.add('success');
                        setTimeout(() => {
                            copyButton.textContent = 'ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼';
                            copyButton.classList.remove('success');
                        }, 3000);
                    });
                });
            }
        };

        // DOMã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        const domHandler = {
            handleDragOver(event) {
                event.preventDefault();
                event.target.style.backgroundColor = "#e0e0e0";
            },

            handleFocus(event) {
                const area = event.target;
                area.style.backgroundColor = "#f0f0f0";
                area.style.borderColor = "#4CAF50";
                const areaType = area.id === "drop-area-html" ? "HTMLã‚¨ãƒªã‚¢" : "URLãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢";
                area.setAttribute('title', `é¸æŠä¸­: ${areaType}`);
            },

            handleBlur(event) {
                const area = event.target;
                area.style.backgroundColor = "#fff";
                area.style.borderColor = "#ccc";
            },

            handleDragLeave(event) {
                event.target.style.backgroundColor = "#fff";
            },

            handleFileDrop(event) {
                event.preventDefault();
                event.target.style.backgroundColor = "#fff";
                const files = event.dataTransfer.files;
                const targetArea = event.target.id === "drop-area-html" ? "html" : "text";
                if (files.length > 0) {
                    const file = files[0];
                    fileHandler.processFile(file, targetArea);
                }
            },

            handlePaste(event) {
                event.preventDefault();
                const area = event.target;
                const text = event.clipboardData.getData('text/plain');
                const targetArea = area.id === "drop-area-html" ? "html" : "text";
                const blob = new Blob([text], { type: 'text/plain' });
                const file = new File([blob], 'pasted-content.txt', { type: 'text/plain' });
                fileHandler.processFile(file, targetArea);
            },

            handleKeyDown(event) {
                if (event.key === 'Tab') {
                    const areas = document.querySelectorAll('.drop-area');
                    areas.forEach(area => {
                        if (document.activeElement === area) {
                            this.handleFocus({ target: area });
                        }
                    });
                }
            }
        };
        document.addEventListener("DOMContentLoaded", () => {
            const dropAreas = document.querySelectorAll('.drop-area');
            dropAreas.forEach(area => {
                area.setAttribute('tabindex', '0');

                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã®å‡¦ç†
                area.addEventListener('dragover', domHandler.handleDragOver);
                area.addEventListener('dragleave', domHandler.handleDragLeave);
                area.addEventListener('drop', domHandler.handleFileDrop);

                // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                area.addEventListener('focus', domHandler.handleFocus);
                area.addEventListener('blur', domHandler.handleBlur);
                area.addEventListener('keydown', domHandler.handleKeyDown);
                area.addEventListener('paste', domHandler.handlePaste);
            });

            // ç½®æ›ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const compareButton = document.getElementById('compareButton');
            compareButton.addEventListener('click', linkHandler.replaceLinks);
        });
        </script>
</body>

</html>
